{"version":3,"sources":["../../src/static/exportRoute.js"],"names":["cachedBasePath","cachedHrefReplace","cachedSrcReplace","config","Comp","DocumentTemplate","route","siteData","clientStats","sharedHashesByProp","templateIndex","data","sharedData","routePath","path","basePath","hrefReplace","RegExp","srcReplace","routeInfo","embeddedRouteInfo","renderMeta","chunkNames","head","clientScripts","clientStyleSheets","clientCss","disableRuntime","redirect","FinalComp","props","chunkName","paths","DIST","startsWith","ROOT","push","renderToStringAndExtract","comp","appHtml","scripts","stylesheets","css","helmet","Helmet","renderStatic","htmlProps","htmlAttributes","toComponent","bodyProps","bodyAttributes","base","link","meta","noscript","script","style","title","beforeRenderToElementHook","plugins","renderToElement","Error","RenderedComp","beforeRenderToHtml","renderToHtml","beforeHtmlToDocument","message","component","renderToStaticMarkup","__html","DocumentHtml","html","beforeDocumentToFile","publicPath","process","env","REACT_STATIC_PUBLIC_PATH","REACT_STATIC_DISABLE_ROUTE_PREFIXING","replace","htmlFilename","nodePath","join","routeInfoFilename","Promise","all","fs","outputFile","outputJson","resolve","res","exportRoute"],"mappings":";;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AAEA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;AAEA;AAEA,IAAIA,cAAJ;AACA,IAAIC,iBAAJ;AACA,IAAIC,gBAAJ;;;;;;;4BAEgB;AAAA;AAAA;AAAA;AAAA;AAAA;AACdC,YAAAA,MADc,QACdA,MADc,EAEdC,IAFc,QAEdA,IAFc,EAGdC,gBAHc,QAGdA,gBAHc,EAIdC,KAJc,QAIdA,KAJc,EAKdC,QALc,QAKdA,QALc,EAMdC,WANc,QAMdA,WANc;AASZC,YAAAA,kBATY,GAcVH,KAdU,CASZG,kBATY,EAUZC,aAVY,GAcVJ,KAdU,CAUZI,aAVY,EAWZC,IAXY,GAcVL,KAdU,CAWZK,IAXY,EAYZC,UAZY,GAcVN,KAdU,CAYZM,UAZY,EAaNC,SAbM,GAcVP,KAdU,CAaZQ,IAbY;AAgBRC,YAAAA,QAhBQ,GAgBGf,cAAc,KAAKA,cAAc,GAAGG,MAAM,CAACY,QAA7B,CAhBjB;AAkBRC,YAAAA,WAlBQ,GAmBZf,iBAAiB,KAChBA,iBAAiB,GAAG,IAAIgB,MAAJ,2BACDF,QAAQ,aAAMA,QAAN,WAAsB,EAD7B,iBAEnB,IAFmB,CADJ,CAnBL;AAyBRG,YAAAA,UAzBQ,GA0BZhB,gBAAgB,KACfA,gBAAgB,GAAG,IAAIe,MAAJ,0BACDF,QAAQ,aAAMA,QAAN,WAAsB,EAD7B,iBAElB,IAFkB,CADJ,CA1BJ,EAgCd;AACA;;AACMI,YAAAA,SAlCQ,GAkCI;AAChBT,cAAAA,aAAa,EAAbA,aADgB;AAEhBD,cAAAA,kBAAkB,EAAlBA,kBAFgB;AAGhBE,cAAAA,IAAI,EAAJA,IAHgB;AAIhBG,cAAAA,IAAI,EAAED,SAJU,CAOlB;AACA;;AARkB,aAlCJ;AA2CRO,YAAAA,iBA3CQ,qBA4CTD,SA5CS;AA6CZP,cAAAA,UAAU,EAAVA,UA7CY;AA8CZL,cAAAA,QAAQ,EAARA,QA9CY,CAiDd;;AAjDc;AAkDRc,YAAAA,UAlDQ,GAkDK,EAlDL;AAmDRC,YAAAA,UAnDQ,GAmDK,EAnDL;AAoDVC,YAAAA,IApDU,GAoDH,EApDG;AAqDVC,YAAAA,aArDU,GAqDM,EArDN;AAsDVC,YAAAA,iBAtDU,GAsDU,EAtDV;AAuDVC,YAAAA,SAvDU,GAuDE,EAvDF;AA2Dd;AACA;AACA;AACA;AACA;AACAtB,YAAAA,IAAI,GAAGD,MAAM,CAACwB,cAAP,GAAwBvB,IAAxB,GAA+BA,IAAI,CAACgB,iBAAD,CAA1C;;AAEA,gBAAId,KAAK,CAACsB,QAAV,EAAoB;AAClBC,cAAAA,SAAS,GAAG;AAAA,uBAAM,6BAAC,iBAAD;AAAU,kBAAA,QAAQ,EAAEvB,KAAK,CAACQ,IAA1B;AAAgC,kBAAA,EAAE,EAAER,KAAK,CAACsB,QAA1C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAAN;AAAA,eAAZ;AACD,aAFD,MAEO;AACLC,cAAAA,SAAS,GAAG,mBAAAC,KAAK;AAAA,uBACf,6BAAC,qCAAD;AACE,kBAAA,MAAM,EAAE,gBAAAC,SAAS,EAAI;AACnB;AACA,wBAAI,CAAC5B,MAAM,CAAC6B,KAAP,CAAaC,IAAb,CAAkBC,UAAlB,CAA6B/B,MAAM,CAAC6B,KAAP,CAAaG,IAA1C,CAAL,EAAsD;AACpDJ,sBAAAA,SAAS,GAAG,+CACV5B,MAAM,CAAC6B,KAAP,CAAaG,IADH,EAEVJ,SAFU,CAAZ;AAID;;AAEDT,oBAAAA,UAAU,CAACc,IAAX,CAAgBL,SAAhB;AACD,mBAXH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAaE,6BAAC,IAAD,eAAUD,KAAV;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAbF,CADe;AAAA,eAAjB;AAiBD;;AAEKO,YAAAA,wBAxFQ,GAwFmB,SAA3BA,wBAA2B,CAAAC,IAAI,EAAI;AACvC;AACA,kBAAMC,OAAO,GAAG,4BAAeD,IAAf,CAAhB;;AAFuC,iCAGD,iCAAY9B,WAAZ,EAAyB;AAC7Dc,gBAAAA,UAAU,EAAVA;AAD6D,eAAzB,CAHC;AAAA,kBAG/BkB,OAH+B,gBAG/BA,OAH+B;AAAA,kBAGtBC,WAHsB,gBAGtBA,WAHsB;AAAA,kBAGTC,GAHS,gBAGTA,GAHS;;AAOvClB,cAAAA,aAAa,GAAGgB,OAAhB;AACAf,cAAAA,iBAAiB,GAAGgB,WAApB;AACAf,cAAAA,SAAS,GAAGgB,GAAZ,CATuC,CAUvC;AACA;;AACA,kBAAMC,MAAM,GAAGC,qBAAOC,YAAP,EAAf;;AACAtB,cAAAA,IAAI,GAAG;AACLuB,gBAAAA,SAAS,EAAEH,MAAM,CAACI,cAAP,CAAsBC,WAAtB,EADN;AAELC,gBAAAA,SAAS,EAAEN,MAAM,CAACO,cAAP,CAAsBF,WAAtB,EAFN;AAGLG,gBAAAA,IAAI,EAAER,MAAM,CAACQ,IAAP,CAAYH,WAAZ,EAHD;AAILI,gBAAAA,IAAI,EAAET,MAAM,CAACS,IAAP,CAAYJ,WAAZ,EAJD;AAKLK,gBAAAA,IAAI,EAAEV,MAAM,CAACU,IAAP,CAAYL,WAAZ,EALD;AAMLM,gBAAAA,QAAQ,EAAEX,MAAM,CAACW,QAAP,CAAgBN,WAAhB,EANL;AAOLO,gBAAAA,MAAM,EAAEZ,MAAM,CAACY,MAAP,CAAcP,WAAd,EAPH;AAQLQ,gBAAAA,KAAK,EAAEb,MAAM,CAACa,KAAP,CAAaR,WAAb,EARF;AASLS,gBAAAA,KAAK,EAAEd,MAAM,CAACc,KAAP,CAAaT,WAAb;AATF,eAAP;AAYA,qBAAOT,OAAP;AACD,aAlHa;;AAAA;AAuHNmB,YAAAA,yBAvHM,GAuHsB,4BAChCvD,MAAM,CAACwD,OADyB,EAEhC,uBAFgC,CAvHtB;AAAA;AAAA,mBA2HMD,yBAAyB,CAAC7B,SAAD,EAAY;AACrD1B,cAAAA,MAAM,EAANA,MADqD;AAErDkD,cAAAA,IAAI,EAAEhC;AAF+C,aAAZ,CA3H/B;;AAAA;AA2HZQ,YAAAA,SA3HY;;AAAA,iBAgIR1B,MAAM,CAACyD,eAhIC;AAAA;AAAA;AAAA;;AAAA,kBAiIJ,IAAIC,KAAJ,6HAjII;;AAAA;AAsIRC,YAAAA,YAtIQ,GAsIO,6BAAC,SAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAtIP,EAwIZ;AACA;;AACMC,YAAAA,kBA1IM,GA0Ie,4BACzB5D,MAAM,CAACwD,OADkB,EAEzB,oBAFyB,CA1If;AAAA;AAAA,mBA8ISI,kBAAkB,CAACD,YAAD,EAAe;AACpD3D,cAAAA,MAAM,EAANA,MADoD;AAEpDkD,cAAAA,IAAI,EAAEhC;AAF8C,aAAf,CA9I3B;;AAAA;AA8IZyC,YAAAA,YA9IY;;AAAA,iBAmJR3D,MAAM,CAAC6D,YAnJC;AAAA;AAAA;AAAA;;AAAA,kBAoJJ,IAAIH,KAAJ,yHApJI;;AAAA;AAyJZtB,YAAAA,OAAO,GAAGF,wBAAwB,CAACyB,YAAD,CAAlC,CAzJY,CA2JZ;;AACMG,YAAAA,oBA5JM,GA4JiB,4BAC3B9D,MAAM,CAACwD,OADoB,EAE3B,sBAF2B,CA5JjB;AAAA;AAAA,mBAgKIM,oBAAoB,CAAC1B,OAAD,EAAU;AAAEpC,cAAAA,MAAM,EAANA,MAAF;AAAUkD,cAAAA,IAAI,EAAEhC;AAAhB,aAAV,CAhKxB;;AAAA;AAgKZkB,YAAAA,OAhKY;AAAA;AAAA;;AAAA;AAAA;AAAA;AAkKZ,wBAAM2B,OAAN,2CAAiD5D,KAAK,CAACQ,IAAvD,eACER,KAAK,CAAC6D,SADR,gBAEM,YAAMD,OAFZ;AAlKY;;AAAA;AAAA,0BAwKOE,4BAxKP;AAAA;AAAA,0BAyKX,gBAzKW;AAAA,0BA0KJ,oCAAiB;AAAE7C,cAAAA,IAAI,EAAJA;AAAF,aAAjB,CA1KI;AAAA;AAAA,mBA4KF,oCAAiB;AACrBA,cAAAA,IAAI,EAAJA,IADqB;AAErBjB,cAAAA,KAAK,EAALA,KAFqB;AAGrBkB,cAAAA,aAAa,EAAbA,aAHqB;AAIrBrB,cAAAA,MAAM,EAANA,MAJqB;AAKrBsB,cAAAA,iBAAiB,EAAjBA,iBALqB;AAMrBC,cAAAA,SAAS,EAATA,SANqB;AAOrB2B,cAAAA,IAAI,EAAEhC;AAPe,aAAjB,CA5KE;;AAAA;AAAA;AAAA,0BAsLJ,oCAAiB;AACrBE,cAAAA,IAAI,EAAJA,IADqB;AAErBjB,cAAAA,KAAK,EAALA,KAFqB;AAGrBc,cAAAA,iBAAiB,EAAjBA,iBAHqB;AAIrBI,cAAAA,aAAa,EAAbA,aAJqB;AAKrBrB,cAAAA,MAAM,EAANA;AALqB,aAAjB,CAtLI;AAAA,0BA6LAI,QA7LA;AAAA,0BA8LCa,iBA9LD;AAAA,0BA+LEC,UA/LF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA0KV,cAAA,IA1KU;AA2KV,cAAA,IA3KU;AAsLV,cAAA,IAtLU;AA6LV,cAAA,QA7LU;AA8LV,cAAA,SA9LU;AA+LV,cAAA,UA/LU;AAAA;AAAA;AAAA;AAAA,2BAiMV;AAAK,cAAA,EAAE,EAAC,MAAR;AAAe,cAAA,uBAAuB,EAAE;AAAEgD,gBAAAA,MAAM,EAAE9B;AAAV,eAAxC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAjMU;AAAA;AAwKR+B,YAAAA,YAxKQ;AAqMd;AACIC,YAAAA,IAtMU,4BAsMeD,YAtMf,GAwMd;;AACME,YAAAA,oBAzMQ,GAyMe,4BAC3BrE,MAAM,CAACwD,OADoB,EAE3B,sBAF2B,CAzMf;AAAA;AAAA,mBA6MDa,oBAAoB,CAACD,IAAD,EAAO;AAAElB,cAAAA,IAAI,EAAEhC;AAAR,aAAP,CA7MnB;;AAAA;AA6MdkD,YAAAA,IA7Mc;AA+Md;AACA;AACME,YAAAA,UAjNQ,GAiNK,6BAAiBC,OAAO,CAACC,GAAR,CAAYC,wBAA7B,CAjNL;;AAkNd,gBAAIF,OAAO,CAACC,GAAR,CAAYE,oCAAZ,KAAqD,MAAzD,EAAiE;AAC/DN,cAAAA,IAAI,GAAGA,IAAI,CAACO,OAAL,CAAa9D,WAAb,cAA+ByD,UAA/B,QAAP;AACD;;AAEDF,YAAAA,IAAI,GAAGA,IAAI,CAACO,OAAL,CAAa5D,UAAb,cAA8BuD,UAA9B,QAAP,CAtNc,CAwNd;AACA;;AACMM,YAAAA,YA1NQ,GA2NZzE,KAAK,CAACQ,IAAN,KAAe,KAAf,GACIkE,cAASC,IAAT,CAAc9E,MAAM,CAAC6B,KAAP,CAAaC,IAA3B,EAAiC,UAAjC,CADJ,GAEI+C,cAASC,IAAT,CAAc9E,MAAM,CAAC6B,KAAP,CAAaC,IAA3B,EAAiC3B,KAAK,CAACQ,IAAvC,EAA6C,YAA7C,CA7NQ,EA+Nd;;AACMoE,YAAAA,iBAhOQ,GAgOYF,cAASC,IAAT,CACxB9E,MAAM,CAAC6B,KAAP,CAAaC,IADW,EAExB3B,KAAK,CAACQ,IAFkB,EAGxB,gBAHwB,CAhOZ;AAAA;AAAA,mBAsOIqE,OAAO,CAACC,GAAR,CAAY,CAC5BC,iBAAGC,UAAH,CAAcP,YAAd,EAA4BR,IAA5B,CAD4B,EAE5B,CAACjE,KAAK,CAACsB,QAAP,GACIyD,iBAAGE,UAAH,CAAcL,iBAAd,EAAiC/D,SAAjC,CADJ,GAEIgE,OAAO,CAACK,OAAR,EAJwB,CAAZ,CAtOJ;;AAAA;AAsORC,YAAAA,GAtOQ;AAAA,6CA4OPA,GA5OO;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;WAAeC,W;;;;SAAAA,W;;;;;;;;;;;;;;;0BAJ3B1F,c;0BACAC,iB;0BACAC,gB","sourcesContent":["import React from 'react'\nimport { renderToString, renderToStaticMarkup } from 'react-dom/server'\nimport Helmet from 'react-helmet'\nimport { ReportChunks } from 'react-universal-component'\nimport flushChunks from 'webpack-flush-chunks'\nimport nodePath from 'path'\nimport fs from 'fs-extra'\n\nimport Redirect from './components/Redirect'\nimport { makePathAbsolute, makeHookReducer } from '../utils'\nimport { absoluteToRelativeChunkName } from '../utils/chunkBuilder'\n\nimport { makeHtmlWithMeta } from './components/HtmlWithMeta'\nimport { makeHeadWithMeta } from './components/HeadWithMeta'\nimport { makeBodyWithMeta } from './components/BodyWithMeta'\n\n//\n\nlet cachedBasePath\nlet cachedHrefReplace\nlet cachedSrcReplace\n\nexport default (async function exportRoute({\n  config,\n  Comp,\n  DocumentTemplate,\n  route,\n  siteData,\n  clientStats,\n}) {\n  const {\n    sharedHashesByProp,\n    templateIndex,\n    data,\n    sharedData,\n    path: routePath,\n  } = route\n\n  const basePath = cachedBasePath || (cachedBasePath = config.basePath)\n\n  const hrefReplace =\n    cachedHrefReplace ||\n    (cachedHrefReplace = new RegExp(\n      `(href=[\"'])\\\\/(${basePath ? `${basePath}\\\\/` : ''})?([^\\\\/])`,\n      'gm'\n    ))\n\n  const srcReplace =\n    cachedSrcReplace ||\n    (cachedSrcReplace = new RegExp(\n      `(src=[\"'])\\\\/(${basePath ? `${basePath}\\\\/` : ''})?([^\\\\/])`,\n      'gm'\n    ))\n\n  // This routeInfo will be saved to disk. It should only include the\n  // data and hashes to construct all of the props later.\n  const routeInfo = {\n    templateIndex,\n    sharedHashesByProp,\n    data,\n    path: routePath,\n  }\n\n  // This embeddedRouteInfo will be inlined into the HTML for this route.\n  // It should include all of the data, including shared data\n  const embeddedRouteInfo = {\n    ...routeInfo,\n    sharedData,\n    siteData,\n  }\n\n  // Make a place to collect chunks, meta info and head tags\n  const renderMeta = {}\n  const chunkNames = []\n  let head = {}\n  let clientScripts = []\n  let clientStyleSheets = []\n  let clientCss = {}\n\n  let FinalComp\n\n  // Get the react component from the Comp and\n  // pass it the export context. This uses\n  // reactContext under the hood to pass down\n  // the exportContext, since react's new context\n  // api doesn't survive across bundling.\n  Comp = config.disableRuntime ? Comp : Comp(embeddedRouteInfo)\n\n  if (route.redirect) {\n    FinalComp = () => <Redirect fromPath={route.path} to={route.redirect} />\n  } else {\n    FinalComp = props => (\n      <ReportChunks\n        report={chunkName => {\n          // if we are building to a absolute path we must make the detected chunkName relative and matching to the one we set in generateTemplates\n          if (!config.paths.DIST.startsWith(config.paths.ROOT)) {\n            chunkName = absoluteToRelativeChunkName(\n              config.paths.ROOT,\n              chunkName\n            )\n          }\n\n          chunkNames.push(chunkName)\n        }}\n      >\n        <Comp {...props} />\n      </ReportChunks>\n    )\n  }\n\n  const renderToStringAndExtract = comp => {\n    // Rend the app to string!\n    const appHtml = renderToString(comp)\n    const { scripts, stylesheets, css } = flushChunks(clientStats, {\n      chunkNames,\n    })\n\n    clientScripts = scripts\n    clientStyleSheets = stylesheets\n    clientCss = css\n    // Extract head calls using Helmet synchronously right after renderToString\n    // to not introduce any race conditions in the meta data rendering\n    const helmet = Helmet.renderStatic()\n    head = {\n      htmlProps: helmet.htmlAttributes.toComponent(),\n      bodyProps: helmet.bodyAttributes.toComponent(),\n      base: helmet.base.toComponent(),\n      link: helmet.link.toComponent(),\n      meta: helmet.meta.toComponent(),\n      noscript: helmet.noscript.toComponent(),\n      script: helmet.script.toComponent(),\n      style: helmet.style.toComponent(),\n      title: helmet.title.toComponent(),\n    }\n\n    return appHtml\n  }\n\n  let appHtml\n\n  try {\n    const beforeRenderToElementHook = makeHookReducer(\n      config.plugins,\n      'beforeRenderToElement'\n    )\n    FinalComp = await beforeRenderToElementHook(FinalComp, {\n      config,\n      meta: renderMeta,\n    })\n\n    if (config.renderToElement) {\n      throw new Error(\n        `config.renderToElement has been deprecated in favor of the 'beforeRenderToElement' or 'beforeRenderToHtml' hooks instead.`\n      )\n    }\n\n    let RenderedComp = <FinalComp />\n\n    // Run the beforeRenderToHtml hook\n    // Rum the Html hook\n    const beforeRenderToHtml = makeHookReducer(\n      config.plugins,\n      'beforeRenderToHtml'\n    )\n    RenderedComp = await beforeRenderToHtml(RenderedComp, {\n      config,\n      meta: renderMeta,\n    })\n\n    if (config.renderToHtml) {\n      throw new Error(\n        `config.renderToHtml has been deprecated in favor of the 'beforeRenderToHtml' or 'beforeHtmlToDocument' hooks instead.`\n      )\n    }\n\n    appHtml = renderToStringAndExtract(RenderedComp)\n\n    // Rum the beforeHtmlToDocument hook\n    const beforeHtmlToDocument = makeHookReducer(\n      config.plugins,\n      'beforeHtmlToDocument'\n    )\n    appHtml = await beforeHtmlToDocument(appHtml, { config, meta: renderMeta })\n  } catch (error) {\n    error.message = `Failed exporting HTML for URL ${route.path} (${\n      route.component\n    }): ${error.message}`\n    throw error\n  }\n\n  const DocumentHtml = renderToStaticMarkup(\n    <DocumentTemplate\n      Html={makeHtmlWithMeta({ head })}\n      Head={\n        await makeHeadWithMeta({\n          head,\n          route,\n          clientScripts,\n          config,\n          clientStyleSheets,\n          clientCss,\n          meta: renderMeta,\n        })\n      }\n      Body={makeBodyWithMeta({\n        head,\n        route,\n        embeddedRouteInfo,\n        clientScripts,\n        config,\n      })}\n      siteData={siteData}\n      routeInfo={embeddedRouteInfo}\n      renderMeta={renderMeta}\n    >\n      <div id=\"root\" dangerouslySetInnerHTML={{ __html: appHtml }} />\n    </DocumentTemplate>\n  )\n\n  // Render the html for the page inside of the base document.\n  let html = `<!DOCTYPE html>${DocumentHtml}`\n\n  // Rum the beforeDocumentToFile hook\n  const beforeDocumentToFile = makeHookReducer(\n    config.plugins,\n    'beforeDocumentToFile'\n  )\n  html = await beforeDocumentToFile(html, { meta: renderMeta })\n\n  // If the siteRoot is set and we're not in staging, prefix all absolute URLs\n  // with the siteRoot\n  const publicPath = makePathAbsolute(process.env.REACT_STATIC_PUBLIC_PATH)\n  if (process.env.REACT_STATIC_DISABLE_ROUTE_PREFIXING !== 'true') {\n    html = html.replace(hrefReplace, `$1${publicPath}$3`)\n  }\n\n  html = html.replace(srcReplace, `$1${publicPath}$3`)\n\n  // If the route is a 404 page, write it directly to 404.html, instead of\n  // inside a directory.\n  const htmlFilename =\n    route.path === '404'\n      ? nodePath.join(config.paths.DIST, '404.html')\n      : nodePath.join(config.paths.DIST, route.path, 'index.html')\n\n  // Make the routeInfo sit right next to its companion html file\n  const routeInfoFilename = nodePath.join(\n    config.paths.DIST,\n    route.path,\n    'routeInfo.json'\n  )\n\n  const res = await Promise.all([\n    fs.outputFile(htmlFilename, html),\n    !route.redirect\n      ? fs.outputJson(routeInfoFilename, routeInfo)\n      : Promise.resolve(),\n  ])\n  return res\n})\n"],"file":"exportRoute.js"}